<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>‚ö°Ô∏èGoGo Lite Premium</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
<style>
:root{
  --bg: linear-gradient(160deg,#212529 0%,#2c3243 42%,#343a40 72%,#495057 100%);
  --glass: rgba(255,255,255,.08);
  --radius: 18px;
  --brand: #ffd43b;
  --accent: #ff6b6b;
  --success: #51cf66;
  --info: #4dabf7;
  --warning: #ffd93d;
  --text: #f8f9fa;
  --blue: #4dabf7;
  --red: #fa5252;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: Inter, sans-serif;
  background: var(--bg);
  display:flex; align-items:center; justify-content:center;
  animation: backgroundShift 20s ease infinite;
}
@keyframes backgroundShift {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
}
#app{
  width: 380px;
  height: 720px; border-radius: 26px; overflow:hidden; position:relative;
  box-shadow:0 20px 45px rgba(0,0,0,.5);
  display:flex; flex-direction:column;
  background: rgba(0,0,0,.6);
  color: var(--text);
}
/* ===== Header ===== */
.header{
  background: rgba(0,0,0,.5);
  backdrop-filter: blur(10px) saturate(140%);
  padding: 10px; position:relative; z-index:3;
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
}
.brand{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.brand-title{
  font-weight:900; font-size:22px;
  background:linear-gradient(270deg,#fff,#ffe66d,#ff6b6b,#fff);
  background-size:600% 600%;
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  animation: shift 7s ease infinite;
}
@keyframes shift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.balance-chip{
  background: rgba(255,255,255,.1); padding:6px 12px; border-radius:999px; font-weight:800;
  display:flex; gap:6px; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,.2);
}
.balance-chip i{color:#51cf66}

/* ===== Menu ƒë√£ ƒëi·ªÅu ch·ªânh ===== */
.main-menu{ 
  display:flex; 
  gap: 4px; 
  margin-top:8px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding-bottom: 5px;
}
.main-btn{
  flex:1; border:none; cursor:pointer; border-radius:14px; padding:8px 4px; 
  background: rgba(255,255,255,.1);
  backdrop-filter: blur(8px) saturate(140%);
  font-weight:700; display:flex; flex-direction: column;
  align-items:center;
  justify-content:center; gap:3px;
  transition:.15s; color: var(--text); 
  font-size:10px;
  min-width: 60px;
}
.main-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.2); }
.main-btn.active{ background: var(--brand);
  box-shadow:0 6px 16px rgba(0,0,0,.3) }
.main-btn span {
    white-space: nowrap;
}
.main-btn .icon-wrapper {
  font-size: 18px;
  transition: transform 0.3s ease-in-out;
}
.main-btn:hover .icon-wrapper {
  animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
  transform: translate3d(0, 0, 0);
  backface-visibility: hidden;
  perspective: 1000px;
}
@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg);
  }
  20%, 80% { transform: translate3d(2px, 0, 0) rotate(2deg);
  }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg);
  }
  40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); }
}


/* ===== Sub Tabs ===== */
.subtabs{ display:flex; gap:8px; padding:8px;
  overflow-x:auto }
.subtab{
  border:none; padding:6px 14px; border-radius:999px; cursor:pointer; font-weight:700;
  background: rgba(255,255,255,.15);
  color: var(--text);
  white-space:nowrap;
}
.subtab.active{ background:var(--brand);
  color:#212529 }

/* ===== Content ===== */
.content{ flex:1; overflow:auto; padding:10px }
.section{
  background: rgba(255,255,255,.05);
  backdrop-filter: blur(10px) saturate(130%);
  border-radius: var(--radius); padding:12px;
  box-shadow: 0 8px 18px rgba(0,0,0,.3);
  animation: fadeIn .2s ease;
}
@keyframes fadeIn{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
.section + .section{ margin-top:12px }
.card{ background: rgba(255,255,255,.1);
  border-radius:14px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,.2); margin-top:8px }
.title{ font-weight:900; margin-bottom:8px; font-size:16px }

/* ===== Check-in grid ===== */
.week-grid{ display:grid; grid-template-columns: repeat(7,1fr);
  gap:6px }
.day{
  background: #343a40;
  color: var(--text);
  border-radius:12px; height:60px; display:flex; flex-direction:column;
  align-items:center; justify-content:center; font-weight:800; font-size:13px; cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  transition:.15s;
}
.day:hover{ transform:translateY(-2px); background:#495057 }
.day.checked{ background:#51cf66; color:#fff }
.day i { font-size: 20px; }

/* ===== Shop ===== */
.shop-grid{ display:grid; grid-template-columns:1fr 1fr;
  gap:10px }
.item{ background:rgba(255,255,255,.1);
border-radius:12px; padding:10px; box-shadow:0 3px 8px rgba(0,0,0,.12) }
.item h4{ margin:0 0 6px;
  font-size:14px }
.item .price{ font-weight:800 }

/* ===== Table ===== */
.table{ width:100%; border-collapse:collapse; margin-top:8px; }
.table th, .table td{ padding:6px; border-bottom:1px solid rgba(255,255,255,.1);
  font-size:13px }
.table th{ background:var(--brand); color:#212529; text-align:left }

/* ===== Toast / Coin ===== */
.coin{ position:absolute; width:18px; height:18px; background:gold; border-radius:50%; top:-20px;
  animation:fall linear forwards }
@keyframes fall{ to{ transform:translateY(860px) rotate(360deg); opacity:0 } }
.overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center;
  z-index:9 }
.toast{ width:86%; max-width:340px; background:linear-gradient(145deg,#495057,#343a40); border-radius:18px; padding:16px; text-align:center; box-shadow:0 14px 40px rgba(0,0,0,.5); color: var(--text); }
.toast h3{ margin:6px 0 4px;
  font-size:18px }
.toast p{ margin:0; opacity:.85; font-size:13px }

/* Helpers */
.muted{ opacity:.6 } .center{text-align:center} .mt8{margin-top:8px} .mt10{margin-top:10px}

/* ====== CSS ph·ª• cho ph·∫ßn n√¢ng c·∫•p ====== */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{background:rgba(255,255,255,.1);border-radius:14px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,.2)}
.stat .big{font-weight:900;font-size:18px}
.progress{height:8px;background:rgba(255,255,255,.1);border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:linear-gradient(90deg,#ffd43b,#ff6b6b);width:0%}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.1);border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 3px 8px rgba(0,0,0,.2)}
.btn{border:none;border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer;background:#ffd43b}
.btn.secondary{background:rgba(255,255,255,.1)}
.modal{width:90%;max-width:360px;background:linear-gradient(145deg,#495057,#343a40);border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:14px;
  color: var(--text)}
.friend{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.1);border-radius:12px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--brand)}
.spin-wheel{width:240px;height:240px;border-radius:50%;margin:12px auto;border:10px solid var(--text);
  background: conic-gradient(#ffd43b 0 60deg,#74c0fc 60deg 120deg,#ff6b6b 120deg 180deg,#51cf66 180deg 240deg,#f783ac 240deg 300deg,#ffe066 300deg 360deg);position:relative}
.spin-pointer{position:absolute;left:50%;top:-18px;transform:translateX(-50%);width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:26px solid #e03131}

/* New CSS for running text */
.running-text-container {
    overflow: hidden;
    white-space: nowrap;
    position: relative;
    padding: 4px 0;
    font-size: 11px;
    opacity: 0.8;
}
.running-text {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 20s linear infinite;
    animation-delay: -5s; /* Start in the middle */
}
@keyframes marquee {
    0%   { transform: translate(0, 0);
    }
    100% { transform: translate(-100%, 0); }
}
/* New CSS for withdraw notification */
.withdraw-alert {
    position: fixed;
    bottom: 0;
    left: 100%;
    transform: translateX(0);
    background: #495057;
    color: #fff;
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    z-index: 10;
    animation: slideAcross 10s linear forwards;
}
@keyframes slideAcross {
    0% { left: 100%; }
    100% { left: -100%;
    }
}
/* New CSS for sponsor logos */
.sponsor-logos {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}
.sponsor-logos .sponsor-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,.1);
    background: rgba(255,255,255,.1);
    padding: 5px;
    object-fit: contain;
    font-size: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.footer-logos {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: 10px;
  background: rgba(0,0,0,.5);
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
}
.footer-logos .gogo-logo {
  font-weight: 800;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 4px;
  animation: shake 2s ease-in-out infinite;
}
@keyframes shake {
    0%, 100% { transform: translateX(0);
    }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-2px);
    }
    20%, 40%, 60%, 80% { transform: translateX(2px); }
}
.withdraw-btn {
  background: #dc3545;
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  padding: 12px 20px;
  border-radius: 12px;
  width: 100%;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
  transition: all 0.3s ease;
}
.withdraw-btn:hover {
  background: #c82333;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(220, 53, 69, 0.6);
}
.deposit-btn {
  background: #28a745;
  color: #fff;
  font-weight: bold;
  padding: 12px 20px;
  border-radius: 12px;
  width: 100%;
  border: none;
  cursor: pointer;
  margin-top: 10px;
}
.bank-info {
  display: flex;
  align-items: center;
  gap: 10px;
}
.bank-logo {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: rgba(255,255,255,.15);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
input[type="number"] {
  font-size: 16px;
  background-color: rgba(255,255,255,.1);
  border: none;
  color: var(--text);
  border-radius: 8px;
}
.action-btn-quest {
    background: #ffd43b;
    color: #212529;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    transition: 0.2s;
}
.action-btn-quest:hover {
    background: #ffc107;
}

/* CSS cho tr√≤ ch∆°i Xanh ƒê·ªè */
.game-container { text-align: center;
}
.timer-display { font-size: 48px; font-weight: 900; }
.bet-options { display: flex; justify-content: space-around; margin: 15px 0; }
.bet-btn { padding: 12px 24px;
  font-size: 16px; font-weight: 800; color: #fff; border: none; border-radius: 12px; cursor: pointer; }
.bet-btn.blue { background-color: var(--blue); }
.bet-btn.red { background-color: var(--red);
}
.bet-input-wrapper { margin: 10px 0; }
.result-history { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-top: 10px;
}
.result-item { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; font-weight: bold;
}
.result-item.blue { background-color: var(--blue); }
.result-item.red { background-color: var(--red); }

/* CSS cho tr√≤ ch∆°i XO */
.xo-board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  width: 240px;
  height: 240px;
  margin: 10px auto;
  background: #343a40;
  border-radius: 10px;
  overflow: hidden;
  gap: 4px;
  padding: 4px;
}
.xo-cell {
  background: #495057;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 900;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}
.xo-cell:hover {
  background: #6c757d;
}
.xo-cell.X { color: var(--blue); }
.xo-cell.O { color: var(--red); }

.contact-info {
  font-size: 12px;
  opacity: 0.8;
}
.active-users {
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  margin-top: 10px;
}
.running-withdraw-alert {
  position: absolute;
  bottom: 0;
  left: 100%;
  transform: translateX(0);
  background: #495057;
  color: #fff;
  padding: 8px 16px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  z-index: 10;
  animation: slideAcross 10s linear forwards;
}
@keyframes slideAcross {
    0% { left: 100%; }
    100% { left: -100%;
    }
}

/* ===== MODIFIED CHATBOT CSS ===== */
.chat-bubble {
  position: fixed;
  bottom: 20px;
  left: 20px;
  /* Move to the left */
  z-index: 1000;
  cursor: grab;
}
.chat-bubble.dragging {
  cursor: grabbing;
}
.chat-btn {
  background: #8fbc8f; /* Lighter green color */
  color: #212529;
  border: none;
  padding: 6px 10px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s;
  font-size: 10px;
  font-weight: 600;
  text-align: center;
  width: 40px;
  height: 40px;
  line-height: 1;
}
.chat-btn:hover {
  transform: scale(1.05);
}
.chat-btn i {
  font-size: 20px;
  margin-bottom: 0;
}
.chat-window {
  position: fixed;
  bottom: 80px;
  left: 20px;
  /* Move to the left */
  width: 320px;
  height: 400px;
  background: #212529;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform: scale(0);
  transform-origin: bottom left;
  /* Adjust origin */
  transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
.chat-window.open {
  transform: scale(1);
}
.chat-header {
  background: #2c3243;
  color: #fff;
  padding: 12px;
  font-weight: bold;
  text-align: center;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}
.chat-header .close-chat {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.chat-input {
  display: flex;
  padding: 8px;
  background: #343a40;
}
.chat-input input {
  flex: 1;
  border: none;
  background: #495057;
  color: var(--text);
  padding: 8px 12px;
  border-radius: 999px;
}
.chat-input button {
  background: var(--brand);
  border: none;
  color: #212529;
  padding: 0 16px;
  margin-left: 8px;
  border-radius: 999px;
  font-weight: 700;
  cursor: pointer;
}
.message {
  padding: 8px 12px;
  border-radius: 14px;
  max-width: 80%;
}
.message.bot {
  background: #343a40;
  align-self: flex-start;
}
.message.user {
  background: #4dabf7;
  align-self: flex-end;
}

/* ===== CRYPTO CSS ===== */
.crypto-chart {
  background: #2c3243;
  border-radius: 12px;
  padding: 12px;
  height: 200px;
  position: relative;
  overflow: hidden;
}
.chart-price {
  font-size: 32px;
  font-weight: 900;
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.price-up { color: #51cf66; }
.price-down { color: #ff6b6b; }
.crypto-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.crypto-actions .btn {
  width: 100%;
}
.buy-btn { background: #51cf66; color: #212529; }
.sell-btn { background: #ff6b6b; color: #212529;
}

</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="brand">
      <div class="brand-title">üöÄ GoGo Lite Premium</div>
      <div class="balance-chip" title="S·ªë d∆∞ hi·ªán t·∫°i">
        <i class="fa-solid fa-coins"></i>
        <span id="balanceText">‚Äî</span>
      </div>
    </div>
    <div class="main-menu" id="mainMenu"></div>
  </div>
  <div class="running-text-container">
    <div class="running-text">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi GoGo Lite Premium!
 Ch√∫c b·∫°n c√≥ m·ªôt ng√†y ki·∫øm ti·ªÅn vui v·∫ª! ‚ú®</div>
  </div>
  <div class="subtabs" id="subTabs"></div>
  <div class="content" id="content"></div>
  <div class="running-withdraw-alert">
    <div class="running-withdraw-text" id="withdrawAlertText"></div>
  </div>
  <div class="footer-logos">
    <div class="gogo-logo">
      GGL <i class="fa-solid fa-sack-dollar"></i>
    </div>
  </div>
</div>

<div class="chat-bubble">
  <button class="chat-btn" id="chatButton">
    <i class="fa-solid fa-comments"></i>
    <span>GGL Chat</span>
  </button>
  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <span>GGL Chat</span>
      <button class="close-chat" id="closeChat">&times;</button>
    </div>
 
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button id="sendChat">G·ª≠i</button>
    </div>
  </div>
</div>

<script>
/********************
 * State & Utilities *
 ********************/
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => (n||0).toLocaleString('vi-VN');
const LS = {
  balance: 'gogo.balance',
  tx: 'gogo.transactions',
  withdraw: 'gogo.withdraws',
  user: 'gogo.user',
  inventory: 'gogo.inventory',
  codes: 'gogo.codes',
  checkin: 'gogo.checkin',
  quests: 'gogo.quests',
  bank: 'gogo.bank',
  blueRed: 'gogo.blueRed',
  xo: 'gogo.xo',
  crypto: 'gogo.crypto' // NEW: crypto state
};
// init state
let balance = parseInt(localStorage.getItem(LS.balance) || '1000000', 10);
let transactions = JSON.parse(localStorage.getItem(LS.tx) || '[]');
let withdrawHistory = JSON.parse(localStorage.getItem(LS.withdraw) || '[]');
let user = JSON.parse(localStorage.getItem(LS.user) || '{"name":"Kh√°ch","exp":0,"avatar":"üü°"}');
let inventory = JSON.parse(localStorage.getItem(LS.inventory) || '[]');
let codes = JSON.parse(localStorage.getItem(LS.codes) || '{}');
let checkin = JSON.parse(localStorage.getItem(LS.checkin) || '{}');
let quests = JSON.parse(localStorage.getItem(LS.quests) || '{}');
let linkedBank = JSON.parse(localStorage.getItem(LS.bank) || 'null');
let blueRed = JSON.parse(localStorage.getItem(LS.blueRed) || '{"history":[], "bet":0, "side": null}');
let xoState = JSON.parse(localStorage.getItem(LS.xo) || '{"wins":0, "losses":0, "draws":0}');
let cryptoState = JSON.parse(localStorage.getItem(LS.crypto) || '{"coinBalance": 0, "investedVND": 0}');
// NEW: crypto state

function save(k,v){ localStorage.setItem(k, typeof v==='string'? v : JSON.stringify(v)); }
function load(k){ try { return JSON.parse(localStorage.getItem(k));
} catch { return null; }}
function saveAll(){
  save(LS.balance, String(balance));
  save(LS.tx, transactions);
  save(LS.withdraw, withdrawHistory);
  save(LS.user, user);
  save(LS.inventory, inventory);
  save(LS.codes, codes);
  save(LS.checkin, checkin);
  save(LS.quests, quests);
  save(LS.bank, linkedBank);
  save(LS.blueRed, blueRed);
  save(LS.xo, xoState);
  save(LS.crypto, cryptoState);
// NEW: save crypto state
}

function nowVN(){ return new Date().toLocaleString('vi-VN'); }
function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10);
}
function weekKey(){
  const d = new Date();
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return `${date.getUTCFullYear()}-W${weekNo}`;
}

function ensureCheckinWeek(){
  const wk = weekKey();
  if(!checkin.weekKey || checkin.weekKey !== wk){
    checkin = { weekKey: wk, days: [], bonusClaimedWeeks: (checkin.bonusClaimedWeeks||[]) };
  save(LS.checkin, checkin);
  }
}

function level(){ return Math.floor((user.exp||0)/1000) + 1; }
function addExp(x){ user.exp = (user.exp||0) + x; save(LS.user, user); renderHeader();
}

// balance & effects
function updateBalance(amount, reason){
  const newBal = balance + amount;
  if(newBal < 0) return false;
  balance = newBal;
  transactions.unshift({ time: nowVN(), amount, reason });
  if(transactions.length>200) transactions.pop();
  saveAll();
  renderHeader();
  popMoney(`${amount>0?'+':''}${fmt(amount)} VNƒê\n${reason||''}`);
  return true;
}

function popMoney(message){
  for(let i=0;i<10;i++){
    const coin=document.createElement('div');
    coin.className='coin';
    coin.style.left=(Math.random()*340+10)+'px';
    coin.style.animationDuration=(Math.random()*1.2+1.4)+'s';
    document.body.appendChild(coin);
    setTimeout(()=>coin.remove(), 2400);
}
  showToast('Th√†nh c√¥ng', message, 'success');
}

function showToast(title, desc, type='info'){
  const overlay=document.createElement('div'); overlay.className='overlay';
  const box=document.createElement('div'); box.className='toast';
  const icon = type==='success'? 'üí∏' : type==='error'? '‚ùå' : '‚ÑπÔ∏è';
  box.innerHTML = `<div style="font-size:40px">${icon}</div>
    <h3>${title}</h3><p>${desc||''}</p>
    <div style="margin-top:10px"><button onclick="this.closest('.overlay').remove()">ƒê√≥ng</button></div>`;
  overlay.appendChild(box); document.body.appendChild(overlay);
  setTimeout(()=>{ if(document.body.contains(overlay)) overlay.remove(); }, 2600);
}

// Function to show withdraw alert
function showWithdrawAlert(user, amount) {
  const alertText = `üéâ ${user} v·ª´a r√∫t ${fmt(amount)} VNƒê!`;
  const alertElement = document.createElement('div');
  alertElement.className = 'running-withdraw-text';
  alertElement.textContent = alertText;

  const container = $('.running-withdraw-alert');
  if (container) {
    container.innerHTML = ''; // Clear previous alerts
    container.appendChild(alertElement);
  }
}

/****************
 * Menu / Tabs  *
 ****************/
const MAIN = {
  home:   { label:'Trang ch·ªß', emoji:'üè†', subtabs:['T·ªïng quan'] },
  checkin:{ label:'ƒêi·ªÉm danh', emoji:'üóìÔ∏è', subtabs:['ƒêi·ªÉm danh tu·∫ßn','Bonus tu·∫ßn'] },
  quests: { label:'Nhi·ªám v·ª•', emoji:'üéØ', subtabs:['Daily','Weekly'] },
  game: { label:'Mini game', emoji:'üéÆ', subtabs:['V√≤ng quay','H·ªôp qu√†','Xanh ƒê·ªè','XO'] },
  crypto: { label:'Crypto', emoji: 'üöÄ', subtabs:['Giao d·ªãch'] }, // NEW: crypto menu
  shop:   { label:'Shop', emoji:'üõçÔ∏è', subtabs:['C·ª≠a h√†ng','Kho ƒë·ªì'] },
  wallet: { label:'V√≠ & L·ªãch s·ª≠', emoji:'üí∞', subtabs:['S·ªë d∆∞','Giao d·ªãch','L·ªãch s·ª≠ r√∫t', 'N·∫°p ti·ªÅn'] },
  community: { label:'C·ªông ƒë·ªìng', emoji:'üë•', subtabs:['B·∫°n b√®'] },
 
  profile:{ label:'C√° nh√¢n', emoji:'üßë‚Äçüíª', subtabs:['H·ªì s∆°','Nh·∫≠p m√£','BXH'] },
};


let currentMain = 'home';
let currentSubIndex = 0;
function renderHeader(){
  $('#balanceText').textContent = fmt(balance) + ' VNƒê';
}

function renderMainMenu(){
  const mm = $('#mainMenu'); mm.innerHTML='';
  Object.entries(MAIN).forEach(([key, cfg])=>{
    const b=document.createElement('button'); b.className='main-btn'+(key===currentMain?' active':'');
    b.innerHTML = `<span class="icon-wrapper">${cfg.emoji}</span><span>${cfg.label}</span>`;
    b.onclick=()=>{ currentMain = key; currentSubIndex = 0; renderSubTabs(); renderContent(); };
    mm.appendChild(b);
  });
}

function renderSubTabs(){
  const st = $('#subTabs'); st.innerHTML='';
  MAIN[currentMain].subtabs.forEach((name, i)=>{
    const b=document.createElement('button'); b.className='subtab'+(i===currentSubIndex?' active':''); b.textContent=name;
    b.onclick=()=>{ currentSubIndex=i; renderContent(); };
    st.appendChild(b);
  });
}

/****************
 * Renderers     *
 ********************/
function renderContent(){
  const c = $('#content'); c.innerHTML='';
  const sub = MAIN[currentMain].subtabs[currentSubIndex];
  if(currentMain==='home'){
    if(sub === 'T·ªïng quan') {
      renderHome(c);
}
  }
  else if(currentMain==='checkin'){
    if(sub==='ƒêi·ªÉm danh tu·∫ßn') {
      renderCheckinWeek(c);
}
    if(sub==='Bonus tu·∫ßn') {
      renderCheckinBonus(c);
}
  }
  else if(currentMain==='quests'){
    if(sub==='Daily') {
      renderQuestDaily(c);
}
    if(sub==='Weekly') {
      renderQuestWeekly(c);
}
  }
  else if(currentMain==='game'){
    if(sub==='V√≤ng quay') {
      renderSpin(c);
}
    if(sub==='H·ªôp qu√†') {
      renderLuckyBox(c);
}
    if(sub==='Xanh ƒê·ªè') {
      renderBlueRedGame(c);
}
    if(sub==='XO') {
      renderXO(c);
}
  }
  else if(currentMain==='crypto'){ // NEW: crypto render function
    if(sub==='Giao d·ªãch') {
      renderCrypto(c);
}
  }
  else if(currentMain==='shop'){
    if(sub==='C·ª≠a h√†ng') {
      renderShop(c);
}
    if(sub==='Kho ƒë·ªì') {
      renderInventory(c);
}
  }
  else if(currentMain==='wallet'){
    if(sub==='S·ªë d∆∞') {
      renderWallet(c);
}
    if(sub==='Giao d·ªãch') {
      renderTx(c);
}
    if(sub==='L·ªãch s·ª≠ r√∫t') {
      renderWithdrawHistory(c);
}
    if(sub==='N·∫°p ti·ªÅn') {
      renderDeposit(c);
}
  }
  else if(currentMain==='community'){
    if(sub==='B·∫°n b√®') {
      renderFriends(c);
}
  }
  else if(currentMain==='profile'){
    if(sub==='H·ªì s∆°') {
      renderProfile(c);
}
    if(sub==='Nh·∫≠p m√£') {
      renderRedeem(c);
}
    if(sub==='BXH') {
      renderLeaderboard(c);
}
  }
  
  const contactInfo = document.createElement('div');
  contactInfo.className = 'section contact-info';
  contactInfo.innerHTML = `
      <div class="title">üìû Li√™n h·ªá</div>
      <p>H·ªó tr·ª£: ********** (Zalo)</p>
      <p>Email: **gogo@support.com**</p>
  `;
  c.appendChild(contactInfo);
  
  const activeUsers = document.createElement('div');
  activeUsers.className = 'section active-users';
  activeUsers.innerHTML = `<i class="fa-solid fa-user-group"></i> <span id="activeUserCount">0</span> ng∆∞·ªùi ƒëang ho·∫°t ƒë·ªông`;
  c.appendChild(activeUsers);
  
  let userCount = 35000;
  function updateActiveUsers() {
      const randomChange = Math.floor(Math.random() * 50) - 25;
  userCount += randomChange;
      const activeUserCountEl = $('#activeUserCount');
      if (activeUserCountEl) {
          activeUserCountEl.textContent = fmt(userCount);
}
  }
  updateActiveUsers(); // Initial update
  setInterval(updateActiveUsers, 5000);
// Update every 5 seconds
}

// Function to calculate VIP level based on deposit amount
function calculateVipLevel() {
    const totalDeposit = transactions
        .filter(tx => tx.reason.includes('N·∫°p ti·ªÅn'))
        .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
// Define VIP level thresholds
    const vipThresholds = [
        100000, 500000, 1000000, 2000000, 5000000,
        10000000, 20000000, 50000000, 100000000
    ];
let currentVip = 0;
    let nextVipThreshold = vipThresholds[0];
    let nextVip = 1;
for (let i = 0; i < vipThresholds.length; i++) {
        if (totalDeposit >= vipThresholds[i]) {
            currentVip = i + 1;
if (i < vipThresholds.length - 1) {
                nextVip = i + 2;
nextVipThreshold = vipThresholds[i + 1];
            } else {
                nextVip = 9;
// Already at max VIP
                nextVipThreshold = totalDeposit;
}
        }
    }

    return { totalDeposit, currentVip, nextVip, nextVipThreshold };
}


function renderHome(c){
  // Create a main container for the home content to avoid rendering issues
  const homeContainer = document.createElement('div');
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`
    <div class="title">‚ú® T·ªïng quan</div>
    <div class="card">
      <div><b>Avatar:</b> <span style="font-size:22px">${user.avatar||'üü°'}</span></div>
      <div class="mt8"><b>T√™n:</b> ${user.name||'Kh√°ch'} &nbsp;
<span class="muted">Lvl ${level()}</span></div>
      <div class="mt8"><b>EXP:</b> ${fmt(user.exp||0)}</div>
      <div class="mt8"><b>Tu·∫ßn hi·ªán t·∫°i:</b> ${weekKey()}</div>
    </div>
  `;
  homeContainer.appendChild(sec);

  // VIP Section
  const { totalDeposit, currentVip, nextVip, nextVipThreshold } = calculateVipLevel();
  const vipSec = document.createElement('div');
  vipSec.className = 'section';
  vipSec.innerHTML = `<div class="title">‚≠ê C·∫•p VIP</div>`;
  const vipCard = document.createElement('div');
  vipCard.className = 'card';
  if (currentVip === 9) {
    vipCard.innerHTML = `
      <div class="center">
        <div style="font-size: 24px; font-weight: bold;">VIP 9</div>
        <div class="muted">B·∫°n ƒë√£ ƒë·∫°t c·∫•p VIP cao nh·∫•t!</div>
        <div class="mt8">T·ªïng n·∫°p: ${fmt(totalDeposit)} VNƒê</div>
      </div>
    `;
} else {
    const progress = (totalDeposit / nextVipThreshold) * 100;
  vipCard.innerHTML = `
      <div class="row">
        <div>C·∫•p VIP hi·ªán t·∫°i: <b>VIP ${currentVip}</b></div>
        <div style="font-size: 14px;">Next: <b>VIP ${nextVip}</b></div>
      </div>
      <div class="progress mt8"><div style="width:${Math.min(progress, 100)}%"></div></div>
      <div class="muted mt8">${fmt(totalDeposit)} / ${fmt(nextVipThreshold)} VNƒê</div>
    `;
}
  vipSec.appendChild(vipCard);
  homeContainer.appendChild(vipSec);

  const bankSec = document.createElement('div');
  bankSec.className = 'section';
  bankSec.innerHTML = `<div class="title">üè¶ V√≠ & Ng√¢n h√†ng</div>`;
  const card = document.createElement('div');
  card.className = 'card';
  if (linkedBank) {
    card.innerHTML = `
      <div class="row"><div><b>${linkedBank.logo} ${linkedBank.name}</b></div>
      <button class="btn secondary" id="chgBank">ƒê·ªïi</button></div>
      <div class="big mt8">${fmt(balance)} VNƒê</div>`;
} else {
    card.innerHTML = `
      <div class="muted">Ch∆∞a li√™n k·∫øt ng√¢n h√†ng</div>
      <button class="btn mt10" id="lnkBank">Li√™n k·∫øt ngay</button>`;
}
  bankSec.appendChild(card);
  homeContainer.appendChild(bankSec);

  const btn = card.querySelector('#lnkBank') || card.querySelector('#chgBank');
  if (btn) btn.onclick = showBankLink;
  const { videos, checkins, vPct, cPct } = weeklyProgress();
  const top = document.createElement('div');
  top.className = 'section';
  top.innerHTML = `
    <div class="row">
      <div class="chip">üßë‚Äçüíª ${user.name ||
'Kh√°ch'}</div>
      <div class="chip">üåü Lvl ${level()}</div>
      <div class="chip">‚ú® EXP ${fmt(user.exp || 0)}</div>
    </div>`;
  homeContainer.appendChild(top);

  const stats = document.createElement('div');
  stats.className = 'section';
  stats.innerHTML = `<div class="title">üìä Th·ªëng k√™ nhanh</div>
    <div class="stats-grid">
      <div class="stat">
        <div>üé¨ Video tu·∫ßn</div>
        <div class="big">${videos}/10</div>
        <div class="progress mt8"><div style="width:${vPct}%"></div></div>
 
      </div>
      <div class="stat">
        <div>üìÖ ƒêi·ªÉm danh</div>
        <div class="big">${checkins}/7</div>
        <div class="progress mt8"><div 
  style="width:${cPct}%"></div></div>
 
      </div>
    </div>
    <div class="row mt10">
      <button class="btn" id="gotoDaily">‚ö°Ô∏è L√†m nhi·ªám v·ª•</button>
      <button class="btn secondary" id="gotoCheckin">üóìÔ∏è ƒêi·ªÉm danh</button>
      <button class="btn secondary" id="gotoShop">üõçÔ∏è Shop</button>
    </div>`;
  homeContainer.appendChild(stats);
  stats.querySelector('#gotoDaily').onclick = () => { currentMain = 'quests'; currentSubIndex = 0; renderSubTabs(); renderContent(); };
  stats.querySelector('#gotoCheckin').onclick = () => { currentMain = 'checkin'; currentSubIndex = 0; renderSubTabs(); renderContent(); };
  stats.querySelector('#gotoShop').onclick = () => { currentMain = 'shop'; currentSubIndex = 0; renderSubTabs(); renderContent(); };

  const news = document.createElement('div');
  news.className = 'section';
  news.innerHTML = `<div class="title">üì∞ B·∫£ng tin</div>
    <div class="card"><b>üî• S·ª± ki·ªán tu·∫ßn:</b> Ho√†n th√†nh 10 video + 7 ng√†y ƒëi·ªÉm danh ‚Üí Th∆∞·ªüng <b>300,000 VNƒê</b>.</div>
    <div class="card mt8"><b>üéÅ M√£ th∆∞·ªüng:</b> D√πng <code>EVENT2025</code> ƒë·ªÉ nh·∫≠n <b>25,000 VNƒê</b>.</div>`;
  homeContainer.appendChild(news);

  const sponsors = document.createElement('div');
  sponsors.className = 'section';
  sponsors.innerHTML = `
    <div class="title">üèÜ ƒê·ªëi t√°c chi·∫øn l∆∞·ª£c</div>
    <div class="sponsor-logos">
      <div class="sponsor-icon">üè¶</div>
      <div class="sponsor-icon">üí≥</div>
      <div class="sponsor-icon">üí∞</div>
      <div class="sponsor-icon">üåê</div>
    </div>`;
  homeContainer.appendChild(sponsors);

  c.appendChild(homeContainer);
}

// Function to calculate VIP level based on deposit amount
function calculateVipLevel() {
    const totalDeposit = transactions
        .filter(tx => tx.reason.includes('N·∫°p ti·ªÅn'))
        .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
// Define VIP level thresholds
    const vipThresholds = [
        100000, 500000, 1000000, 2000000, 5000000,
        10000000, 20000000, 50000000, 100000000
    ];
let currentVip = 0;
    let nextVipThreshold = vipThresholds[0];
    let nextVip = 1;
for (let i = 0; i < vipThresholds.length; i++) {
        if (totalDeposit >= vipThresholds[i]) {
            currentVip = i + 1;
if (i < vipThresholds.length - 1) {
                nextVip = i + 2;
nextVipThreshold = vipThresholds[i + 1];
            } else {
                nextVip = 9;
// Already at max VIP
                nextVipThreshold = totalDeposit;
}
        }
    }

    return { totalDeposit, currentVip, nextVip, nextVipThreshold };
}


// H√†m m·ªõi ƒë·ªÉ t√≠nh th∆∞·ªüng ƒëi·ªÉm danh d·ª±a tr√™n c·∫•p VIP
function getDailyCheckinReward() {
    const { currentVip } = calculateVipLevel();
// M·ª©c th∆∞·ªüng tƒÉng d·∫ßn theo c·∫•p VIP, gi·ªõi h·∫°n t·ª´ 5k ƒë·∫øn 55k
    const rewards = [5000, 10000, 15000, 20000, 25000, 30000, 35000, 45000, 55000, 55000];
return rewards[Math.min(currentVip, rewards.length - 1)];
}

function renderCheckinWeek(c){
  ensureCheckinWeek();
  const weekDays=['T2','T3','T4','T5','T6','T7','CN'];
  const dailyReward = getDailyCheckinReward();
// L·∫•y m·ª©c th∆∞·ªüng m·ªõi
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML = `<div class="title">üìÖ ƒêi·ªÉm danh theo tu·∫ßn (+${fmt(dailyReward)}/ng√†y)</div>`;
  const grid=document.createElement('div');
  grid.className='week-grid mt10';
  for(let i=1;i<=7;i++){
    const d=document.createElement('div');
    const today = new Date().getDay() + 1;
// 1-7
    const isToday = (i === today);
    const isChecked = checkin.days.includes(i);
  d.className = 'day' + (isChecked ? ' checked' : '') + (isToday ? ' active-day' : '');
  d.innerHTML = `<i class="fa-solid fa-sack-dollar"></i><small>${weekDays[(i-1)%7]}</small>`;
    d.onclick=()=>{
      if(isChecked) {
        showToast("Th√¥ng b√°o", "Ng√†y n√†y b·∫°n ƒë√£ ƒëi·ªÉm danh r·ªìi.", "info");
  return;
      }
      if(!isToday) {
        showToast("Th√¥ng b√°o", "B·∫°n ch·ªâ c√≥ th·ªÉ ƒëi·ªÉm danh cho ng√†y h√¥m nay.", "info");
  return;
      }
      if(updateBalance(dailyReward, `ƒêi·ªÉm danh ng√†y ${i}`)) { 
        checkin.days.push(i);
  save(LS.checkin, checkin);
        addExp(50); 
        const q = ensureQuestToday();
        q.checkinToday = true;
        save(LS.quests, quests);
        renderContent();
      }
    };
    grid.appendChild(d);
}
  sec.appendChild(grid);

  const noteCard = document.createElement('div');
  noteCard.className = 'card mt10';
  noteCard.innerHTML = `
    <div style="font-weight: bold;">L∆∞u √Ω khi ƒëi·ªÉm danh:</div>
    <ul>
        <li>N√™n ƒëi·ªÉm danh v√†o **bu·ªïi s√°ng s·ªõm** ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c may m·∫Øn.</li>
        <li>**Tuy·ªát ƒë·ªëi kh√¥ng** s·ª≠ d·ª•ng ph·∫ßn m·ªÅm gi·∫£ l·∫≠p, hack ho·∫∑c cheat.</li>
        <li>Ch·ªâ ƒëi·ªÉm danh **m·ªôt l·∫ßn duy nh·∫•t** trong ng√†y.</li>
    </ul>`;
  sec.appendChild(noteCard);

  const scheduleCard = document.createElement('div');
  scheduleCard.className = 'card mt10';
  scheduleCard.innerHTML = `
    <div style="font-weight: bold;">L·ªãch tr√¨nh h√¥m nay:</div>
    <ul>
        <li>**08:00 - 10:00:** ƒêi·ªÉm danh ƒë·ªÉ nh·∫≠n th√™m 20 EXP.</li>
        <li>**12:00 - 14:00:** Ho√†n th√†nh nhi·ªám v·ª• video ƒë·ªÉ nh·∫≠n th√™m 10 EXP.</li>
        <li>**18:00 - 20:00:** Tham gia mini game V√≤ng quay may m·∫Øn.</li>
    </ul>`;
  sec.appendChild(scheduleCard);

  c.appendChild(sec);
}


function renderCheckinBonus(c){
  ensureCheckinWeek();
  const done7 = checkin.days && checkin.days.length >= 7;
  const already = (checkin.bonusClaimedWeeks || []).includes(checkin.weekKey);
  const sec = document.createElement('div'); 
  sec.className = 'section';
  sec.innerHTML = `<div class="title">üéÅ Th∆∞·ªüng tu·∫ßn (+200,000 VNƒê)</div>`;

  const card = document.createElement('div');
  card.className = 'card mt8';
  
  if (done7) {
    card.innerHTML = `<div class="center" style="font-weight: bold;">B·∫°n ƒë√£ ƒë·ªß ƒëi·ªÅu ki·ªán nh·∫≠n th∆∞·ªüng tu·∫ßn!</div>`;
} else {
    card.innerHTML = `<div class="center muted">Ho√†n th√†nh ƒë·ªß 7 ng√†y ƒëi·ªÉm danh trong tu·∫ßn ƒë·ªÉ nh·∫≠n th∆∞·ªüng.</div>`;
}

  const btn = document.createElement('button');
  btn.className = 'btn mt10';
  btn.style.width = '100%';
  btn.textContent = 'Nh·∫≠n Bonus +200,000 VNƒê';
  btn.disabled = !done7 || already;
  
  btn.onclick = () => {
    if(done7 && !already){
      checkin.bonusClaimedWeeks.push(checkin.weekKey);
  save(LS.checkin, checkin);
      if(updateBalance(200000,'Bonus tu·∫ßn')){ 
        addExp(120); 
        renderContent();
}
    }
  };

  sec.appendChild(card);
  sec.appendChild(btn); 
  c.appendChild(sec);
}

function ensureQuestToday(){
  const key=todayKey();
  if(!quests[key]) quests[key]={
    video:0,
    claimVideo:false,
    share:false,
    claimShare:false,
    invite:false,
    claimInvite:false,
    checkinToday: false,
    spinToday: false
  };
return quests[key];
}

function renderQuestDaily(c){
  const q=ensureQuestToday();
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üìù Nhi·ªám v·ª• ng√†y</div>`;

  const notesCard = document.createElement('div');
  notesCard.className = 'card mt8';
  notesCard.innerHTML = `
      <div style="font-weight: bold;">L∆∞u √Ω khi l√†m nhi·ªám v·ª•:</div>
      <ul>
          <li>M·ªói nhi·ªám v·ª• ch·ªâ c√≥ th·ªÉ l√†m **m·ªôt l·∫ßn duy nh·∫•t** m·ªói ng√†y.</li>
          <li>B·∫°n ph·∫£i ho√†n th√†nh nhi·ªám v·ª• ƒë·ªÉ c√≥ th·ªÉ nh·∫≠n th∆∞·ªüng.</li>
          <li>Th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c c·ªông th·∫≥ng v√†o s·ªë d∆∞ c·ªßa b·∫°n.</li>
      </ul>
  `;
  sec.appendChild(notesCard);

  // Quest 1: Xem video
  const card1=document.createElement('div'); card1.className='card mt10';
  card1.innerHTML=`
    <div class="row">
        <div><b>Xem video:</b> ${q.video}/3</div>
        <button class="action-btn-quest" id="doVideo">L√†m</button>
    </div>`;
  const btn1=card1.querySelector('#doVideo');
  btn1.disabled = q.claimVideo;
  btn1.onclick=()=>{
    if(q.video>=3 && !q.claimVideo) {
      if(updateBalance(50000, 'Ho√†n th√†nh nhi·ªám v·ª• video')){
        q.claimVideo=true;
  addExp(40); save(LS.quests,quests); renderContent();
      }
      return;
    }
    btn1.disabled=true; let t=15;
  const iv=setInterval(()=>{
      t--; btn1.textContent=`ƒêang xem ${t}s`;
      if(t<=0){ clearInterval(iv); q.video++; save(LS.quests,quests); renderContent(); }
    },1000);
};
  sec.appendChild(card1);

  // Quest 2: Chia s·∫ª ·ª©ng d·ª•ng
  const card2=document.createElement('div'); card2.className='card mt10';
  card2.innerHTML = `
    <div class="row">
        <div><b>Chia s·∫ª ·ª©ng d·ª•ng:</b> ${q.share ?
'Ho√†n th√†nh' : 'Ch∆∞a'}</div>
        <button class="action-btn-quest" id="doShare">L√†m</button>
    </div>`;
  const btn2 = card2.querySelector('#doShare');
  btn2.disabled = q.claimShare;
  btn2.onclick = () => {
    if(!q.claimShare){
      // Show app link and update state
      if (updateBalance(10000, 'Chia s·∫ª ·ª©ng d·ª•ng')) {
        q.share = true;
  q.claimShare = true;
        addExp(20);
        save(LS.quests, quests);
        showToast("Th√†nh c√¥ng", "B·∫°n ƒë√£ chia s·∫ª ·ª©ng d·ª•ng. +10,000 VNƒê", "success");
// Simulated app link pop-up
        window.open('https://appstore.com/gogo-lite-premium', '_blank');
        renderContent();
}
    }
  };
  sec.appendChild(card2);
  // Quest 3: M·ªùi b·∫°n b√®
  const card3=document.createElement('div'); card3.className='card mt10';
  card3.innerHTML = `
    <div class="row">
        <div><b>M·ªùi b·∫°n b√®:</b> ${q.invite ?
'Ho√†n th√†nh' : 'Ch∆∞a'}</div>
        <button class="action-btn-quest" id="doInvite">L√†m</button>
    </div>`;
  const btn3 = card3.querySelector('#doInvite');
  btn3.disabled = q.claimInvite;
  btn3.onclick = () => {
    if(!q.claimInvite){
      if(updateBalance(10000, 'M·ªùi b·∫°n b√®')){
        q.invite = true;
  q.claimInvite = true;
        addExp(25);
        save(LS.quests, quests);
        showToast("Th√†nh c√¥ng", "B·∫°n ƒë√£ m·ªùi b·∫°n b√®. +10,000 VNƒê", "success");
// Simulated referral link pop-up
        window.open('https://gogo.vn/referral?id=user12345', '_blank');
        renderContent();
}
    }
  };
  sec.appendChild(card3);
  // New quest: Daily Check-in
  const card4 = document.createElement('div');
  card4.className = 'card mt10';
  card4.innerHTML = `
    <div class="row">
        <div><b>ƒêi·ªÉm danh h√†ng ng√†y:</b> ${q.checkinToday ?
'Ho√†n th√†nh' : 'Ch∆∞a'}</div>
        <button class="action-btn-quest" id="doCheckinDaily">L√†m</button>
    </div>
  `;
  const btn4 = card4.querySelector('#doCheckinDaily');
  btn4.disabled = q.checkinToday;
  btn4.onclick = () => {
    if (q.checkinToday) {
        showToast("Th√¥ng b√°o", "B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• n√†y r·ªìi.", "info");
  return;
    }
    const today = new Date().getDay() + 1;
    ensureCheckinWeek();
  if (checkin.days.includes(today)) {
        if (updateBalance(20000, "Ho√†n th√†nh nhi·ªám v·ª• ƒëi·ªÉm danh")) {
            q.checkinToday = true;
  addExp(15);
            save(LS.quests, quests);
            renderContent();
        }
    } else {
        showToast("H∆∞·ªõng d·∫´n", "H√£y ƒë·∫øn m·ª•c 'ƒêi·ªÉm danh' ƒë·ªÉ ho√†n th√†nh nhi·ªám v·ª•.", "info");
}
  };
  sec.appendChild(card4);

  // New quest: Spin the Wheel
  const card5 = document.createElement('div');
  card5.className = 'card mt10';
  card5.innerHTML = `
    <div class="row">
        <div><b>Quay V√≤ng quay may m·∫Øn:</b> ${q.spinToday ?
'Ho√†n th√†nh' : 'Ch∆∞a'}</div>
        <button class="action-btn-quest" id="doSpin">L√†m</button>
    </div>
  `;
  const btn5 = card5.querySelector('#doSpin');
  btn5.disabled = q.spinToday;
  btn5.onclick = () => {
    if (q.spinToday) {
        showToast("Th√¥ng b√°o", "B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• n√†y r·ªìi.", "info");
  return;
    }
    showToast("H∆∞·ªõng d·∫´n", "H√£y ƒë·∫øn m·ª•c Mini game > V√≤ng quay ƒë·ªÉ ho√†n th√†nh nhi·ªám v·ª•.", "info");
};
  sec.appendChild(card5);
  
  c.appendChild(sec);
}
function renderQuestWeekly(c){
  ensureCheckinWeek();
  let vid=0; Object.values(quests).forEach(q=> vid += (q.video||0));
  const sec=document.createElement('div'); sec.className='section';
  const canClaim = (vid>=10) && (checkin.days && checkin.days.length>=7);
  sec.innerHTML = `
    <div class="title">üì¶ Nhi·ªám v·ª• tu·∫ßn (Th∆∞·ªüng l·ªõn)</div>
    <div class="card">üé¨ Video: ${Math.min(vid,10)}/10
      <div class="progress mt8"><div style="width:${Math.min(Math.round((vid/10)*100),100)}%"></div></div>
    </div>
    <div class="card mt8">üìÖ ƒêi·ªÉm danh: ${checkin.days?checkin.days.length:0}/7
      <div class="progress mt8"><div style="width:${Math.min(Math.round(((checkin.days?checkin.days.length:0)/7)*100),100)}%"></div></div>
    </div>
  `;
  const btn=document.createElement('button'); btn.className='btn mt10'; btn.style.width='100%'; btn.textContent='Nh·∫≠n +300,000 VNƒê';
  btn.disabled = !canClaim;
  btn.onclick=()=>{
    if(!canClaim) return;
  updateBalance(300000,'Th∆∞·ªüng nhi·ªám v·ª• tu·∫ßn'); addExp(200); showToast('Ch√∫c m·ª´ng','B·∫°n ƒë√£ nh·∫≠n 300,000 VNƒê','success');
    btn.disabled=true;
  };
  sec.appendChild(btn);
  c.appendChild(sec);
}

function renderSpin(c){
  const cost = 50000;
  const sec=document.createElement('div');
  sec.className='section';
  sec.innerHTML = `<div class="title">üé∞ V√≤ng quay may m·∫Øn</div>
      <div class="card center">M·ªói l∆∞·ª£t quay t·ªën ${fmt(cost)} VNƒê</div>`;
  const wheel = document.createElement('div'); wheel.className='spin-wheel';
  const pointer = document.createElement('div'); pointer.className='spin-pointer';
  wheel.appendChild(pointer);
  sec.appendChild(wheel);

  const btn = document.createElement('button'); btn.className='btn'; btn.style.width='100%'; btn.textContent='Quay ngay';
  btn.onclick = ()=>{
    if (balance < cost) {
      showToast('Kh√¥ng ƒë·ªß s·ªë d∆∞', 'B·∫°n c·∫ßn c√≥ √≠t nh·∫•t 50,000 VNƒê ƒë·ªÉ quay.', 'error');
  return;
    }
    if (!updateBalance(-cost, 'Ph√≠ v√≤ng quay')) {
      showToast('L·ªói', 'Kh√¥ng th·ªÉ tr·ª´ ti·ªÅn t·ª´ s·ªë d∆∞.', 'error');
  return;
    }

    btn.disabled = true;
    const deg = 720 + Math.floor(Math.random()*360);
    wheel.style.transition='transform 3s cubic-bezier(.2,.8,.2,1)';
    wheel.style.transform=`rotate(${deg}deg)`;
  setTimeout(()=>{
      btn.disabled=false;
      const prize=["+20,000 VNƒê","+50 EXP","+10,000 VNƒê","H·ª•t r·ªìi","+30,000 VNƒê","+80 EXP"];
      const idx=Math.floor(((deg%360)/60));
      const reward=prize[(6-idx)%6];
      if(reward.includes("VNƒê")) updateBalance(parseInt(reward.replace(/\D/g,'')),"V√≤ng quay");
      else if(reward.includes("EXP")) addExp(parseInt(reward.replace(/\D/g,'')));
      showToast("K·∫øt qu·∫£", reward, 'success');
      const q = ensureQuestToday();
      q.spinToday = true;
      save(LS.quests, quests);
      renderContent();
    },3100);
};
  sec.appendChild(btn);
  c.appendChild(sec);
}

function renderLuckyBox(c){
  const cost = 50000;
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML = `<div class="title">üéÅ H·ªôp qu√† b√≠ ·∫©n</div>
    <div class="card center">M·ªói l·∫ßn m·ªü t·ªën ${fmt(cost)} VNƒê ‚Äî ph·∫ßn th∆∞·ªüng ng·∫´u nhi√™n.</div>`;
  const btn=document.createElement('button'); btn.className='btn'; btn.style.width='100%'; btn.textContent='M·ªü h·ªôp';
  btn.onclick=()=>{
    if (balance < cost) {
      showToast('Kh√¥ng ƒë·ªß s·ªë d∆∞', 'B·∫°n c·∫ßn c√≥ √≠t nh·∫•t 50,000 VNƒê ƒë·ªÉ m·ªü h·ªôp.', 'error');
  return;
    }
    if (!updateBalance(-cost, 'Ph√≠ m·ªü h·ªôp qu√†')) {
      showToast('L·ªói', 'Kh√¥ng th·ªÉ tr·ª´ ti·ªÅn t·ª´ s·ªë d∆∞.', 'error');
  return;
    }

    const gifts=[10000,20000,50000];
    const val=gifts[Math.floor(Math.random()*gifts.length)];
    updateBalance(val,"H·ªôp qu√† b√≠ ·∫©n"); addExp(30);
  showToast("B·∫°n nh·∫≠n ƒë∆∞·ª£c", `+${fmt(val)} VNƒê`, 'success');
};
  sec.appendChild(btn); c.appendChild(sec);
}

function renderBlueRedGame(c){
    let betAmount = 0;
  let chosenSide = null;
    let timer = 30;
  let countdownInterval = null;
    let gameRunning = false;

    const gameContainer = document.createElement('div');
  gameContainer.className = 'section game-container';
  const renderGame = () => {
        gameContainer.innerHTML = `
            <div class="title">üé≤ Xanh ƒê·ªè</div>
            <div id="gameStatus" class="mt8" style="font-size: 14px;"></div>
            ${!gameRunning ?
`<button class="btn" id="startGameBtn" style="width:100%; margin-top:10px">B·∫Øt ƒë·∫ßu ch∆°i</button>` : `
            <div class="timer-display" style="font-size:48px; font-weight: 900">${timer}s</div>
            <div class="bet-input-wrapper">
                <input type="number" id="betAmount" placeholder="S·ªë ti·ªÅn c∆∞·ª£c" style="width: 80%; padding: 10px; font-size: 16px;">
            </div>
            <div class="bet-options">
           
                <button class="bet-btn blue" data-side="blue">ƒê·∫∑t Xanh</button>
                <button class="bet-btn red" data-side="red">ƒê·∫∑t ƒê·ªè</button>
            </div>
            `}
            <div class="card mt10">
                <div style="font-weight: bold;">L·ªãch s·ª≠ k·∫øt qu·∫£:</div>
 
            
                <div id="resultHistory" class="result-history mt8"></div>
            </div>
        `;
  if (!gameRunning) {
            gameContainer.querySelector('#startGameBtn').onclick = () => {
                gameRunning = true;
  startCountdown();
            };
        } else {
            const betInput = gameContainer.querySelector('#betAmount');
  betInput.value = betAmount > 0 ? betAmount : '';

            const betButtons = gameContainer.querySelectorAll('.bet-btn');
  betButtons.forEach(btn => {
                if (btn.dataset.side === chosenSide) {
                    btn.style.opacity = '0.5';
                }
                btn.onclick = () => {
                    
                    if (chosenSide) return showToast('L·ªói', 'B·∫°n ƒë√£ ƒë·∫∑t c∆∞·ª£c r·ªìi.', 'error');
                    const amount = parseInt(betInput.value) || 0;
                    if (amount <= 0 || amount > balance) {
                  
                        showToast('L·ªói', 'S·ªë ti·ªÅn c∆∞·ª£c kh√¥ng h·ª£p l·ªá', 'error');
       
                        return;
                    }
                  
                      
                    if (updateBalance(-amount, `C∆∞·ª£c ${fmt(amount)} VNƒê v√†o ${btn.dataset.side === 'blue' ? 'Xanh' : 'ƒê·ªè'}`)) {
          
                        betAmount = amount;
         
                      chosenSide = btn.dataset.side;
                     
                        renderGame();
                    }
       
  };
            });
}
        
        const historyDiv = gameContainer.querySelector('#resultHistory');
  blueRed.history.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${result}`;
            historyDiv.appendChild(resultItem);
        });
};

    const startCountdown = () => {
        timer = 30;
        betAmount = 0;
  chosenSide = null;
        renderGame();
        
        countdownInterval = setInterval(() => {
            timer--;
            const timerDisplay = gameContainer.querySelector('.timer-display');
            if(timerDisplay) timerDisplay.textContent = `${timer}s`;

            if (timer <= 0) {
                clearInterval(countdownInterval);
                endRound();
  
            
            }
        }, 1000);
};

    const endRound = () => {
        const result = Math.random() > 0.5 ?
'blue' : 'red';
        blueRed.history.unshift(result);
        if (blueRed.history.length > 10) blueRed.history.pop();
        
        if (chosenSide && chosenSide === result) {
            const winnings = betAmount * 2;
  updateBalance(winnings, `Th·∫Øng game Xanh ƒê·ªè (x2)`);
        }
        save(LS.blueRed, blueRed);
        renderGame();
        setTimeout(startCountdown, 5000);
    };
  c.appendChild(gameContainer);
    renderGame();
}

function renderXO(c) {
    const WIN_REWARD = 20000;
    const LOSE_PENALTY = 10000;
  let board = ['', '', '', '', '', '', '', '', ''];
  let currentPlayer = 'X';
    let isGameActive = true;
  const gameContainer = document.createElement('div');
    gameContainer.className = 'section center';
  gameContainer.innerHTML = `
      <div class="title">‚ùå‚≠ï Tr√≤ ch∆°i XO</div>
      <div class="card mt8">
        <p id="gameStatus">L∆∞·ª£t c·ªßa b·∫°n (X)</p>
      </div>
      <div class="xo-board">
        ${board.map((_, i) => `<div class="xo-cell" data-index="${i}"></div>`).join('')}
      </div>
      <button class="btn mt10" id="resetBtn">Ch∆°i l·∫°i</button>
      <div class="card mt10">
        <div class="stats-grid">
 
            <div class="stat">Th·∫Øng: <span class="big">${xoState.wins}</span></div>
          <div class="stat">Thua: <span class="big">${xoState.losses}</span></div>
          <div class="stat">H√≤a: <span class="big">${xoState.draws}</span></div>
        </div>
      </div>
    `;
  const cells = gameContainer.querySelectorAll('.xo-cell');
    const statusDisplay = gameContainer.querySelector('#gameStatus');
    const resetBtn = gameContainer.querySelector('#resetBtn');
  const winningConditions = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8],
      [0, 3, 6], [1, 4, 7], [2, 5, 8],
      [0, 4, 8], [2, 4, 6]
    ];
  function handleResultValidation() {
        let roundWon = false;
  for (let i = 0; i < winningConditions.length; i++) {
            const winCondition = winningConditions[i];
  let a = board[winCondition[0]];
            let b = board[winCondition[1]];
            let c = board[winCondition[2]];
  if (a === '' || b === '' || c === '') continue;
  if (a === b && b === c) {
                roundWon = true;
  break;
            }
        }

        if (roundWon) {
            statusDisplay.textContent = `Ng∆∞·ªùi ch∆°i ${currentPlayer} ƒë√£ th·∫Øng!`;
  isGameActive = false;
            if (currentPlayer === 'X') {
                xoState.wins++;
  updateBalance(WIN_REWARD, "Th·∫Øng XO");
            } else {
                xoState.losses++;
  updateBalance(-LOSE_PENALTY, "Thua XO");
  }
            save(LS.xo, xoState);
            renderContent();
            return;
}

        if (!board.includes('')) {
            statusDisplay.textContent = `Tr·∫≠n ƒë·∫•u h√≤a!`;
  isGameActive = false;
            xoState.draws++;
            save(LS.xo, xoState);
            renderContent();
            return;
        }

        currentPlayer = currentPlayer === 'X' ?
'O' : 'X';
        statusDisplay.textContent = `L∆∞·ª£t c·ªßa ${currentPlayer}`;
    }

    function handleCellClick(clickedCell, clickedCellIndex) {
        if (board[clickedCellIndex] !== '' || !isGameActive) return;
  board[clickedCellIndex] = currentPlayer;
        clickedCell.textContent = currentPlayer;
        clickedCell.classList.add(currentPlayer);
        handleResultValidation();
        if(isGameActive && currentPlayer === 'O') {
            setTimeout(computerTurn, 500);
}
    }

    function computerTurn() {
        let emptyCells = board.map((cell, i) => cell === '' ? i : null).filter(val => val !== null);
  let bestMove = -1;

        // Try to win
        for(let i of emptyCells) {
            let tempBoard = [...board];
  tempBoard[i] = 'O';
            if(checkWin(tempBoard, 'O')) { bestMove = i; break;
}
        }

        // Block player from winning
        if(bestMove === -1) {
            for(let i of emptyCells) {
                let tempBoard = [...board];
  tempBoard[i] = 'X';
                if(checkWin(tempBoard, 'X')) { bestMove = i; break;
}
            }
        }
        
        // Take center or corners
        if(bestMove === -1 && emptyCells.includes(4)) bestMove = 4;
  if(bestMove === -1) {
            const corners = [0, 2, 6, 8];
  const availableCorners = emptyCells.filter(i => corners.includes(i));
            if(availableCorners.length > 0) bestMove = availableCorners[Math.floor(Math.random() * availableCorners.length)];
}

        // Take any side
        if(bestMove === -1) {
            const sides = [1, 3, 5, 7];
  const availableSides = emptyCells.filter(i => sides.includes(i));
            if(availableSides.length > 0) bestMove = availableSides[Math.floor(Math.random() * availableSides.length)];
}


        if (bestMove !== -1) {
            handleCellClick(cells[bestMove], bestMove);
}
    }

    function checkWin(board, player) {
        for (let i = 0; i < winningConditions.length; i++) {
            const [a, b, c] = winningConditions[i];
  if (board[a] === player && board[b] === player && board[c] === player) {
                return true;
}
        }
        return false;
}

    cells.forEach((cell, index) => {
        cell.addEventListener('click', () => handleCellClick(cell, index));
    });
  resetBtn.addEventListener('click', () => {
        board = ['', '', '', '', '', '', '', '', ''];
        isGameActive = true;
        currentPlayer = 'X';
        statusDisplay.textContent = `L∆∞·ª£t c·ªßa b·∫°n (X)`;
        cells.forEach(cell => {
            cell.textContent = '';
            cell.classList.remove('X', 'O');
        });
 
    
    });

    c.appendChild(gameContainer);
}

// NEW: Crypto render function
let currentCryptoPrice = 100;
  let cryptoPriceInterval = null;
function renderCrypto(c) {
    const sec = document.createElement('div');
    sec.className = 'section';
  sec.innerHTML = `
        <div class="title">üöÄ Giao d·ªãch ti·ªÅn ·∫£o</div>
        <div class="card mt8">
            <div class="crypto-chart">
                <div class="chart-price" id="cryptoPrice">${fmt(currentCryptoPrice)} VNƒê</div>
            </div>
            <div class="mt10">
              <div class="row">
   
                <div class="muted">S·ªë d∆∞ VNƒê: ${fmt(balance)}</div>
                <div class="muted">S·ªë Coin: ${cryptoState.coinBalance.toFixed(2)} GO</div>
              </div>
              <div class="row mt8">
                <div class="muted">ƒê√£ ƒë·∫ßu t∆∞: ${fmt(cryptoState.investedVND)} VNƒê</div>
         
                <div class="muted">Gi√° tr·ªã hi·ªán t·∫°i: ${fmt(cryptoState.coinBalance * currentCryptoPrice)} VNƒê</div>
              </div>
            </div>
            <input type="number" id="tradeAmount" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng Coin" style="width:100%;padding:10px;margin-top:10px;">
            <div class="crypto-actions mt10">
              
   
              <button class="btn buy-btn" id="buyBtn">Mua</button>
          
                <button class="btn sell-btn" id="sellBtn">B√°n</button>
            </div>
        </div>
    `;
  c.appendChild(sec);
    
    // Start price simulation
    if (cryptoPriceInterval) clearInterval(cryptoPriceInterval);
  cryptoPriceInterval = setInterval(() => {
        const change = (Math.random() - 0.5) * 5; // Price change between -2.5 and +2.5
        currentCryptoPrice = Math.max(1, currentCryptoPrice + change);
        const priceEl = $('#cryptoPrice');
        if (priceEl) {
            priceEl.textContent = fmt(currentCryptoPrice) + ' VNƒê';
            priceEl.classList.toggle('price-up', change > 0);
        
            priceEl.classList.toggle('price-down', change < 0);
        } else {
            clearInterval(cryptoPriceInterval);
        }
    }, 1000);
  $('#buyBtn').onclick = () => {
        const amount = parseFloat($('#tradeAmount').value) || 0;
  const cost = amount * currentCryptoPrice;
        if (amount <= 0) return showToast('L·ªói', 'S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.', 'error');
  if (balance < cost) return showToast('L·ªói', 'Kh√¥ng ƒë·ªß VNƒê ƒë·ªÉ mua.', 'error');

        updateBalance(-cost, `Mua ${amount} GO`);
        cryptoState.coinBalance += amount;
  cryptoState.investedVND += cost;
        save(LS.crypto, cryptoState);
        renderContent();
    };

    $('#sellBtn').onclick = () => {
        const amount = parseFloat($('#tradeAmount').value) ||
0;
        const profit = amount * currentCryptoPrice;
        if (amount <= 0) return showToast('L·ªói', 'S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.', 'error');
  if (cryptoState.coinBalance < amount) return showToast('L·ªói', 'Kh√¥ng ƒë·ªß GO ƒë·ªÉ b√°n.', 'error');

        updateBalance(profit, `B√°n ${amount} GO`);
        cryptoState.coinBalance -= amount;
  cryptoState.investedVND -= (amount / cryptoState.coinBalance) * cryptoState.investedVND;
        save(LS.crypto, cryptoState);
        renderContent();
    };
}


function renderShop(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üõçÔ∏è C·ª≠a h√†ng</div>`;
  const grid=document.createElement('div'); grid.className='shop-grid';
  const items=[{id:'c1',name:'Coupon +10k',price:10000},{id:'exp50',name:'EXP +50',price:20000}];
  items.forEach(it=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<h4>${it.name}</h4><div class="price">${fmt(it.price)} VNƒê</div>
      <button class="main-btn mt8" style="width:100%">Mua</button>`;
    el.querySelector('button').onclick=()=>{
      if(updateBalance(-it.price,'Mua '+it.name)){ inventory.push(it); save(LS.inventory,inventory); addExp(20); renderContent(); }
      else showToast('Kh√¥ng ƒë·ªß s·ªë d∆∞','N·∫°p th√™m ƒë·ªÉ mua','error');
    };
    grid.appendChild(el);
  });
  sec.appendChild(grid); c.appendChild(sec);
}
function renderInventory(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üéí Kho ƒë·ªì</div>`;
  if(inventory.length===0) sec.innerHTML+='<div class="muted">Ch∆∞a c√≥ v·∫≠t ph·∫©m</div>';
  else {
    const box=document.createElement('div'); box.className='card';
    box.innerHTML = inventory.map(it=>`‚Ä¢ ${it.name}`).join('<br>');
    sec.appendChild(box);
  }
  c.appendChild(sec);
}

function renderWallet(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üí∞ S·ªë d∆∞: ${fmt(balance)} VNƒê</div>`;

  const linkBankCard = document.createElement('div');
  linkBankCard.className = 'card mt8 center';
  
  if (linkedBank) {
      linkBankCard.innerHTML = `
        <div style="font-weight: bold;">Ng√¢n h√†ng ƒë√£ li√™n k·∫øt:</div>
        <div class="bank-info mt8">
          <div class="bank-logo">
            ${linkedBank.logo}
          </div>
          <div>
            <div><b>${linkedBank.name}</b></div>
      
            <div class="muted">${linkedBank.accountNumber}</div>
          </div>
        </div>
        <button class="btn mt10" id="chgBank">Thay ƒë·ªïi</button>`;
  linkBankCard.querySelector('#chgBank').onclick = showBankLink;
  } else {
    linkBankCard.innerHTML = `<div class="muted">B·∫°n ch∆∞a li√™n k·∫øt ng√¢n h√†ng.</div>
                               <button class="btn mt10" id="lnkBank">Li√™n k·∫øt ngay</button>`;
  linkBankCard.querySelector('#lnkBank').onclick = showBankLink;
  }
  sec.appendChild(linkBankCard);
  
  // Withdrawal Section
  const withdrawSec = document.createElement('div');
  withdrawSec.className = 'section mt10';
  withdrawSec.innerHTML = `<div class="title">R√∫t ti·ªÅn</div>`;
  
  const withdrawForm = document.createElement('div');
  withdrawForm.className = 'card mt8';
  withdrawForm.innerHTML = `<input id="wAmount" type="number" placeholder="S·ªë ti·ªÅn mu·ªën r√∫t (>= 50,000)" style="width:100%;padding:10px;margin:6px 0;">
                            <button class="withdraw-btn" id="wBtn" style="width:100%">R√∫t</button>`;
  withdrawForm.querySelector('#wBtn').onclick = () => {
    if (!linkedBank) {
        return showToast('L·ªói', 'Vui l√≤ng li√™n k·∫øt ng√¢n h√†ng tr∆∞·ªõc khi r√∫t ti·ªÅn.', 'error');
}
    
    const amt = parseInt(withdrawForm.querySelector('#wAmount').value) || 0;
  if (amt < 50000) return showToast('T·ªëi thi·ªÉu 50k', 'S·ªë ti·ªÅn r√∫t ph·∫£i t·ª´ 50.000 VNƒê tr·ªü l√™n.', 'error');
  if (balance < amt) return showToast('Kh√¥ng ƒë·ªß s·ªë d∆∞', 'Vui l√≤ng n·∫°p th√™m ti·ªÅn ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch.', 'error');
  if (updateBalance(-amt, `R√∫t ti·ªÅn v·ªÅ ${linkedBank.name}`)) {
        withdrawHistory.unshift({time: nowVN(), amount: amt, bank: linkedBank.name});
  save(LS.withdraw, withdrawHistory);
        showWithdrawAlert(user.name, amt);
        renderContent();
    }
  };
  withdrawSec.appendChild(withdrawForm);
  
  c.appendChild(sec);
  c.appendChild(withdrawSec);
}

function renderDeposit(c) {
  const sec = document.createElement('div');
  sec.className = 'section';
  sec.innerHTML = `<div class="title">üíµ N·∫°p ti·ªÅn</div>`;

  const infoCard = document.createElement('div');
  infoCard.className = 'card';
  infoCard.innerHTML = `<div class="muted">N·∫°p ti·ªÅn v√†o v√≠ c·ªßa b·∫°n. Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn mu·ªën n·∫°p ƒë·ªÉ l·∫•y th√¥ng tin chuy·ªÉn kho·∫£n.</div>`;
  sec.appendChild(infoCard);

  const depositForm = document.createElement('div');
  depositForm.className = 'card mt10';
  depositForm.innerHTML = `
    <input id="dAmount" type="number" placeholder="S·ªë ti·ªÅn mu·ªën n·∫°p (>= 10,000)" style="width:100%;padding:10px;margin:6px 0;">
    <button class="deposit-btn" id="dBtn" style="width:100%">Ti·∫øp t·ª•c</button>`;
  depositForm.querySelector('#dBtn').onclick = () => {
    const amt = parseInt(depositForm.querySelector('#dAmount').value) || 0;
  if (amt < 10000) return showToast('T·ªëi thi·ªÉu 10k', 'S·ªë ti·ªÅn n·∫°p ph·∫£i t·ª´ 10.000 VNƒê tr·ªü l√™n.', 'error');
    showDepositInfo(amt);
  };
  sec.appendChild(depositForm);
  c.appendChild(sec);
}

function showDepositInfo(amount) {
    const overlay = document.createElement('div');
    overlay.className = 'overlay';

    const box = document.createElement('div');
  box.className = 'modal';

    // Simulated bank account information
    const bankInfo = {
        name: 'MB Bank',
        accountHolder: 'DINH ANH CHANG',
        accountNumber: '0394539007',
        transferContent: 'N·∫°p ti·ªÅn v√†o gogo lite',
        qrCode: 'https://cdn.example.com/tcb_qr.png'
    };
  box.innerHTML = `
        <div class="row">
            <h3 style="margin:0; flex:1">Th√¥ng tin n·∫°p ti·ªÅn</h3>
            <button type="button" class="btn secondary" id="closeDeposit">ƒê√≥ng</button>
        </div>
        <div class="card mt10">
            <div class="bank-info" style="align-items: flex-start;">
                <div>
       
              <div style="font-weight: bold;">Ng√¢n h√†ng:</div>
                    <div class="mt8">T√™n t√†i kho·∫£n:</div>
                    <div class="mt8">S·ªë t√†i kho·∫£n:</div>
                    <div class="mt8">N·ªôi dung chuy·ªÉn kho·∫£n:</div>
                    <div class="mt8">S·ªë ti·ªÅn c·∫ßn n·∫°p:</div>
             
                  </div>
                <div>
                    <div style="font-weight: bold; color: var(--brand);">${bankInfo.name}</div>
                    <div class="mt8">${bankInfo.accountHolder}</div>
                    <div 
  class="mt8">${bankInfo.accountNumber}</div>
                    <div class="mt8">${bankInfo.transferContent}</div>
                                
                <div class="mt8" style="color: var(--brand); font-weight: bold;">${fmt(amount)} VNƒê</div>
                </div>
            </div>
            <div class="center mt10">
   
              <p class="muted" style="font-size: 11px;">Vui l√≤ng 
  chuy·ªÉn kho·∫£n ƒë√∫ng s·ªë ti·ªÅn v√† n·ªôi dung ƒë·ªÉ ƒë∆∞·ª£c c·ªông t·ª± ƒë·ªông.</p>
            </div>
   
         </div>
        <button class="deposit-btn mt10" style="width: 100%" id="confirmDeposit">ƒê√£ chuy·ªÉn kho·∫£n</button>
    `;
  box.querySelector('#closeDeposit').onclick = () => overlay.remove();

    box.querySelector('#confirmDeposit').onclick = () => {
        // Here we simulate the deposit after user confirms
        updateBalance(amount, 'N·∫°p ti·ªÅn v√†o v√≠');
  showToast('N·∫°p ti·ªÅn th√†nh c√¥ng', `B·∫°n ƒë√£ n·∫°p ${fmt(amount)} VNƒê v√†o v√≠.`, 'success');
        overlay.remove();
        renderContent();
    };

    overlay.appendChild(box);
    document.body.appendChild(overlay);
}

function renderTx(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üßæ Giao d·ªãch g·∫ßn ƒë√¢y</div>`;
  const tbl=document.createElement('table'); tbl.className='table';
  tbl.innerHTML='<thead><tr><th>Th·ªùi gian</th><th>L√Ω do</th><th>S·ªë ti·ªÅn</th></tr></thead><tbody></tbody>';
  const tb=tbl.querySelector('tbody');
  transactions.slice(0,10).forEach(tx=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${tx.time}</td><td>${tx.reason}</td><td>${tx.amount>0?'+':''}${fmt(tx.amount)}</td>`;
    tb.appendChild(tr);
  });
  sec.appendChild(tbl); c.appendChild(sec);
}
function renderWithdrawHistory(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üè¶ L·ªãch s·ª≠ r√∫t</div>`;
  const tbl=document.createElement('table'); tbl.className='table';
  tbl.innerHTML='<thead><tr><th>Th·ªùi gian</th><th>Ng√¢n h√†ng</th><th>S·ªë ti·ªÅn</th></tr></thead><tbody></tbody>';
  const tb=tbl.querySelector('tbody');
  withdrawHistory.slice(0,10).forEach(w=>{
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${w.time}</td><td>${w.bank || 'Ch∆∞a li√™n k·∫øt'}</td><td>${fmt(w.amount)} VNƒê</td>`; 
    tb.appendChild(tr);
  });
  sec.appendChild(tbl); c.appendChild(sec);
}

function renderProfile(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üë§ H·ªì s∆°</div>`;
  const card=document.createElement('div'); card.className='card';
  card.innerHTML = `
    <div><b>Avatar:</b> <span id="avatarShow" style="font-size:22px">${user.avatar||'üü°'}</span></div>
    <div class="mt8"><input id="nameInp" value="${user.name}" style="width:100%;padding:8px" placeholder="T√™n hi·ªÉn th·ªã"></div>
    <div class="mt8"><input id="avatarInp" value="${user.avatar||'üü°'}" style="width:100%;padding:8px" placeholder="Emoji avatar (vd: üü°, üò∫)"></div>
    <button class="main-btn mt8" style="width:100%" id="saveProfile">L∆∞u</button>`;
  card.querySelector('#saveProfile').onclick=()=>{
    user.name=$('#nameInp').value.trim()||'Kh√°ch';
    user.avatar=$('#avatarInp').value.trim()||'üü°';
    save(LS.user,user); renderHeader(); renderContent();
  };
  sec.appendChild(card); c.appendChild(sec);
}
function renderRedeem(c){
  const validCodes = [
    "JFHF7J", "X45VQQ", "HHB76Z", "WD1GSV1P", "DRJ3IER", "R36CLS", "EEXNQVO0", "KEHRSJ", "UBE24T7L", "ZLJUAUC",
    "4V807QSG", "777GTE", "L39I8C4J", "ULLDKLTP", "9BEAROK5", "YQ0ZRL", "CXAPTV", "B14KSXAB", "W90KZA", "66I9WI8",
    "PFV4VG", "OHA57R2", "4OX7GVV8", "JNSJ4Z2Z", "BIOSVATI", "ENN7VG", "527Q612W", "3PFFOC", "E4BK5MW", "OBZNWC",
    "EV0X4FQ", "EU4OFEEV", "SOY364", "H6Z934", "1A6P3KJZ", "ACBCBPN", "C19A60T", "7C8HIEF6", "9LVEKX0", "F96TGP",
    "JS0P8GG", "MPW5AJH", "0KPAOEHT", "9TGHHO4", "E021S0LB", "6K7NNW9V", "GFXS2N", "HM99A8F", "3CCS5PM", "Y5XMXE6",
    "FWK6BSE", "GXKXU247", "FHF9Z2", "RH3IW4", "Z9083SWA", "TKY27NE", "SY818J22", "MX2VSWX", "9Z1N65", "8G377PG",
    "VOLXJIFB", "3ZMCE8", "8RVUYQ", "MIBD5GQ", "QTVZL2", "A0QY7JQ", "J2R1FN", "0HVNGL", "I4BZES4", "Y22VG0",
    "3VMPTHM", "XXPXAZ", "V22KDR", "37X8E0D", "7W2R8J", "OIQCKVQ", "1K3FEJ", "7G5BMA8", "CZY41J0", "2Y49IVQ",
    "0WBIVH", "MJU40L", "SZJD7OL", "VCP3WO", "KQF92I", "X3A0KUL", "S7JQTV", "L89JGOT", "H7K2U5", "8T0AKW",
    "D7Z6P2", "UM05H1", "4VYOCF", "6I92G5", "LPOB7I", "YN6Z0U"
  ];
  
  const sec = document.createElement('div');
  sec.className = 'section';
  sec.innerHTML = `<div class="title">üîë Nh·∫≠p m√£</div>`;
  const input = document.createElement('input');
  input.placeholder = "Nh·∫≠p m√£ b·∫•t k·ª≥ ƒë·ªÉ nh·∫≠n th∆∞·ªüng";
  input.style.cssText = "width:100%;padding:10px";
  const btn = document.createElement('button');
  btn.className = 'main-btn mt8';
  btn.style.width = '100%';
  btn.textContent = 'Nh·∫≠n';

  btn.onclick = () => {
    const code = input.value.trim().toUpperCase();
    
    // Check if the code has already been used
    if (codes[code]) {
      return showToast('M√£ ƒë√£ d√πng r·ªìi', '', 'error');
    }

    // Check if the code is in the list of valid codes
    if (!validCodes.includes(code)) {
      return showToast('M√£ kh√¥ng h·ª£p l·ªá', 'Vui l√≤ng ki·ªÉm tra l·∫°i m√£', 'error');
    }

    // If the code is valid and not used, proceed with the reward
    codes[code] = true;
    save(LS.codes, codes);
    const randomReward = Math.floor(Math.random() * (50000 - 10000 + 1)) + 10000;
    updateBalance(randomReward, 'Nh·∫≠p m√£ ' + code);
    addExp(50);
    renderContent();
  };

  sec.appendChild(input);
  sec.appendChild(btn);
  c.appendChild(sec);
}
function renderLeaderboard(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML=`<div class="title">üèÜ B·∫£ng x·∫øp h·∫°ng</div>`;
  const me = { name: user.name, score: (user.exp || 0) + balance / 1000 };
  const bots = [
    { name: 'Aqua', avatar: 'üíô', exp: 12000, balance: 2500000 },
    { name: 'Nova', avatar: '‚ú®', exp: 9800, balance: 1900000 },
    { name: 'Milo', avatar: 'üê±', exp: 6200, balance: 1300000 },
    { name: 'Luna', avatar: 'üåï', exp: 4500, balance: 1050000 },
    { name: 'Leo', avatar: 'ü¶Å', exp: 3800, balance: 800000 },
    { name: 'Ivy', avatar: 'üåø', exp: 2900, balance: 650000 },
  ];
  const list = [...bots, me];
  list.forEach(p => p.score = (p.exp || 0) + (p.balance / 1000));
  list.sort((a, b) => b.score - a.score);

  const tbl = document.createElement('table');
  tbl.className = 'table';
  tbl.innerHTML = '<thead><tr><th>H·∫°ng</th><th>T√™n</th><th>ƒêi·ªÉm</th></tr></thead><tbody></tbody>';
  const tb = tbl.querySelector('tbody');
  list.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i + 1}</td><td>${p.avatar ? p.avatar + ' ' : ''}${p.name}</td><td>${fmt(Math.round(p.score))}</td>`;
    tb.appendChild(tr);
  });
  sec.appendChild(tbl);
  c.appendChild(sec);
}

function weeklyProgress(){
  let vid=0; Object.values(quests).forEach(q=> vid += (q.video||0));
  ensureCheckinWeek();
  const chk = (checkin.days? checkin.days.length : 0);
  return {
    videos: Math.min(vid, 10),
    checkins: Math.min(chk, 7),
    vPct: Math.min(Math.round((vid/10)*100),100),
    cPct: Math.min(Math.round((chk/7)*100),100),
  };
}

const BANKS = [
  {id:'vcb', name:'Vietcombank', logo:'üè¶', accountNumber:''},
  {id:'bidv', name:'BIDV', logo:'üí≥', accountNumber:''},
  {id:'tcb', name:'Techcombank', logo:'üí∞', accountNumber:''},
  {id:'mb', name:'MB Bank', logo:'üè¶', accountNumber:''},
  {id:'acb', name:'ACB', logo:'üí≥', accountNumber:''}
];
function showBankLink(){
  const overlay=document.createElement('div'); overlay.className='overlay';
  const box=document.createElement('div'); box.className='modal';
  
  const form = document.createElement('form');
  form.innerHTML = `
    <div class="row">
      <b>üè¶ Li√™n k·∫øt ng√¢n h√†ng</b>
      <button type="button" class="btn secondary" id="closeB">ƒê√≥ng</button>
    </div>
    <div class="bank-list mt10">
      ${BANKS.map(b => `
        <div class="bank-item" data-bank-id="${b.id}">
          <div class="bank-logo">üí∞</div>
          <div><b>${b.name}</b></div>
        </div>`).join('')}
    </div>
    <input type="text" id="accountNumberInput" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n" style="width:100%;padding:10px;margin-top:10px;font-size:16px;">
 
    <button type="submit" class="btn mt10" style="width:100%">L∆∞u</button>
  `;
  
  let selectedBank = null;
  form.querySelectorAll('.bank-item').forEach(item => {
    item.onclick = () => {
      $$('.bank-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      selectedBank = BANKS.find(b => b.id === item.dataset.bankId);
    };
  });
  form.onsubmit = (e) => {
    e.preventDefault();
    if (!selectedBank) {
      return showToast('L·ªói', 'Vui l√≤ng ch·ªçn m·ªôt ng√¢n h√†ng.', 'error');
}
    const accountNumber = $('#accountNumberInput').value.trim();
    if (!accountNumber) {
      return showToast('L·ªói', 'Vui l√≤ng nh·∫≠p s·ªë t√†i kho·∫£n.', 'error');
}

    linkedBank = {
      id: selectedBank.id,
      name: selectedBank.name,
      logo: selectedBank.logo,
      accountNumber: accountNumber
    };
  save(LS.bank, linkedBank);
    overlay.remove();
    showToast("Li√™n k·∫øt th√†nh c√¥ng", "ƒê√£ li√™n k·∫øt "+linkedBank.name, "success");
    renderContent();
  };

  box.appendChild(form);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  box.querySelector('#closeB').onclick=()=>overlay.remove();
}

function renderFriends(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML = `<div class="title">üë• B·∫°n b√®</div>`;
  const friends = [
    {name:'Aqua', avatar:'üíô', exp:1500, balance:220000},
    {name:'Nova', avatar:'‚ú®', exp: 980, balance:150000},
    {name:'Milo', avatar:'üê±', exp: 620, balance: 90000},
  ];
  friends.forEach(f=>{
    const row=document.createElement('div'); row.className='friend mt8';
    row.innerHTML = `
      <div class="avatar">${f.avatar}</div>
      <div style="flex:1">
        <div class="row"><b>${f.name}</b><span class="muted">EXP ${fmt(f.exp)}</span></div>
        <div class="progress mt8"><div style="width:${Math.min((f.exp%1000)/10,100)}%"></div></div>
        <div class="muted mt8">S·ªë d∆∞: ${fmt(f.balance)} VNƒê</div>
      </div>
      <button class="btn secondary sendTip">T·∫∑ng 5k</button>`;
    row.querySelector('.sendTip').onclick=()=>{
      if(updateBalance(-5000, `T·∫∑ng ${f.name}`)) showToast('ƒê√£ t·∫∑ng', `B·∫°n t·∫∑ng ${f.name} 5,000 VNƒê`, 'success');
  
    };
    sec.appendChild(row);
  });
  c.appendChild(sec);
}

const SHOP_ITEMS = [
  {id:'exp50', name:'EXP +50', price:20000, type:'EXP', desc:'TƒÉng ngay 50 EXP.'},
  {id:'exp200', name:'EXP +200', price:70000, type:'EXP', desc:'TƒÉng 200 EXP ƒë·ªÉ l√™n c·∫•p nhanh.'},
  {id:'c10', name:'Coupon +10k', price:10000, type:'Coupon', desc:'Th·∫ª c·ªông 10,000 VNƒê v√†o v√≠.'},
  {id:'c30', name:'Coupon +30k', price:28000, type:'Coupon', desc:'Th·∫ª c·ªông 30,000 VNƒê v√†o v√≠.'},
  {id:'boost', name:'EXP Boost x2 (24h)', price:120000, type:'Boost', desc:'Nh√¢n ƒë√¥i EXP trong 24 gi·ªù (demo).'},
];
let shopFilter = 'all';

function showItemDetail(it){
  const overlay=document.createElement('div'); overlay.className='overlay';
  const box=document.createElement('div'); box.className='modal';
  box.innerHTML = `
    <div class="row"><b>${it.name}</b><button class="btn secondary" id="cls">ƒê√≥ng</button></div>
    <div class="muted mt8">${it.desc}</div>
    <div class="row mt10"><div><b>Gi√°:</b> ${fmt(it.price)} VNƒê</div><button class="btn" id="buy">Mua ngay</button></div>`;
  overlay.appendChild(box); document.body.appendChild(overlay);
  box.querySelector('#cls').onclick=()=>overlay.remove();
  box.querySelector('#buy').onclick=()=>{
    if(updateBalance(-it.price, 'Mua '+it.name)){
      inventory.push(it); save(LS.inventory, inventory); addExp(20);
      overlay.remove();
  showToast('ƒê√£ mua', it.name, 'success'); renderContent();
    }else{
      showToast('Kh√¥ng ƒë·ªß s·ªë d∆∞','N·∫°p th√™m ƒë·ªÉ mua','error');
}
  };
}

const _oldShop = renderShop;
renderShop = function(c){
  const sec=document.createElement('div'); sec.className='section';
  sec.innerHTML = `<div class="title">üõçÔ∏è C·ª≠a h√†ng</div>`;
  const filter=document.createElement('div'); filter.className='row';
  filter.innerHTML = `
    <div class="chip">L·ªçc:</div>
    <button class="btn secondary" data-ft="all">T·∫•t c·∫£</button>
    <button class="btn secondary" data-ft="EXP">EXP</button>
    <button class="btn secondary" data-ft="Coupon">Coupon</button>
    <button class="btn secondary" data-ft="Boost">Boost</button>
  `;
  filter.querySelectorAll('button[data-ft]').forEach(b=>{
    b.onclick=()=>{ shopFilter=b.getAttribute('data-ft'); renderContent(); };
  });
  sec.appendChild(filter);
  const grid=document.createElement('div'); grid.className='shop-grid mt10';
  SHOP_ITEMS.filter(it=> shopFilter==='all' || it.type===shopFilter).forEach(it=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `
      <h4>${it.name}</h4>
      <div class="muted">${it.type}</div>
      <div class="row mt8">
        <div class="price">${fmt(it.price)} VNƒê</div>
        <button class="btn secondary">Chi ti·∫øt</button>
      </div>`;
    el.querySelector('button').onclick=()=>showItemDetail(it);
    grid.appendChild(el);
  });
  if(!grid.children.length){
    const none=document.createElement('div'); none.className='card'; none.textContent='Kh√¥ng c√≥ s·∫£n ph·∫©m.';
    sec.appendChild(none);
  }else{
    sec.appendChild(grid);
  }
  c.appendChild(sec);
};

let notifications = [
  {title:"üéÅ Khuy·∫øn m√£i", msg:"Nh·∫≠p m√£ EVENT2025 nh·∫≠n ngay 25,000 VNƒê"},
  {title:"üî• Nhi·ªám v·ª• tu·∫ßn", msg:"Xem ƒë·ªß 10 video & ƒëi·ªÉm danh 7 ng√†y ƒë·ªÉ nh·∫≠n +300k"},
  {title:"üõçÔ∏è Shop", msg:"M·ªü b√°n g√≥i EXP Boost m·ªõi"}
];
function showNotifications(){
  const overlay=document.createElement('div'); overlay.className='overlay';
  const box=document.createElement('div'); box.className='modal';
  box.innerHTML = `<div class="row"><b>üîî Th√¥ng b√°o</b><button class="btn secondary" id="closeN">ƒê√≥ng</button></div>`;
  notifications.forEach(n=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<div><b>${n.title}</b></div><div class="muted">${n.msg}</div>`;
    box.appendChild(card);
  });
  overlay.appendChild(box); document.body.appendChild(overlay);
  box.querySelector('#closeN').onclick=()=>overlay.remove();
}

const _oldHeader = renderHeader;
let _bellMounted = false;
renderHeader = function(){
  _oldHeader();
  if(!_bellMounted){
    const bell = document.createElement('button');
    bell.className='btn secondary';
    bell.style.marginLeft='8px';
    bell.innerHTML='üîî';
    bell.onclick=showNotifications;
    document.querySelector('.brand').appendChild(bell);
    _bellMounted = true;
  }
};
/* ===== NEW CHATBOT JAVASCRIPT ===== */
document.addEventListener('DOMContentLoaded', () => {
    const chatButton = $('#chatButton');
    const chatWindow = $('#chatWindow');
    const closeChat = $('#closeChat');
    const chatMessages = $('#chatMessages');
    const chatInput = $('#chatInput');
    const sendChat = $('#sendChat');

    chatButton.addEventListener('click', () => {
        chatWindow.classList.toggle('open');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    closeChat.addEventListener('click', () => {
        chatWindow.classList.remove('open');
    });

 
    function addMessage(text, isUser = false) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getBotResponse(message) {
        const msg = message.toLowerCase().trim();
  if (msg.includes('ch√†o') || msg.includes('hello')) {
            return "Xin ch√†o! B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?";
}
        if (msg.includes('r√∫t ti·ªÅn') || msg.includes('r√∫t')) {
            return "ƒê·ªÉ r√∫t ti·ªÅn, b·∫°n h√£y v√†o m·ª•c V√≠ & L·ªãch s·ª≠ > L·ªãch s·ª≠ r√∫t. S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 50,000 VNƒê.";
}
        if (msg.includes('n·∫°p ti·ªÅn') || msg.includes('n·∫°p')) {
            return "B·∫°n c√≥ th·ªÉ n·∫°p ti·ªÅn t·∫°i m·ª•c V√≠ & L·ªãch s·ª≠ > N·∫°p ti·ªÅn. S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 10,000 VNƒê.";
}
        if (msg.includes('nhi·ªám v·ª•') || msg.includes('daily')) {
            return "Nhi·ªám v·ª• h√†ng ng√†y gi√∫p b·∫°n ki·∫øm ti·ªÅn v√† EXP. H√£y v√†o m·ª•c Nhi·ªám v·ª• ƒë·ªÉ xem chi ti·∫øt nh√©!";
}
        if (msg.includes('ƒëi·ªÉm danh') || msg.includes('diem danh')) {
            return "B·∫°n c√≥ th·ªÉ ƒëi·ªÉm danh m·ªói ng√†y ƒë·ªÉ nh·∫≠n ti·ªÅn th∆∞·ªüng. V√†o m·ª•c ƒêi·ªÉm danh ƒë·ªÉ th·ª±c hi·ªán.";
}
        if (msg.includes('li√™n h·ªá')) {
            return "N·∫øu b·∫°n c·∫ßn h·ªó tr·ª£ th√™m, vui l√≤ng li√™n h·ªá Zalo: ********** ho·∫∑c Email: **gogo@support.com**.";
}
        
        return "T√¥i ch∆∞a hi·ªÉu √Ω b·∫°n. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ r√∫t/n·∫°p ti·ªÅn, nhi·ªám v·ª• ho·∫∑c ƒëi·ªÉm danh.";
}

    function sendMessage() {
        const text = chatInput.value.trim();
  if (text === '') return;
        
        addMessage(text, true);
        chatInput.value = '';
  setTimeout(() => {
            const botResponse = getBotResponse(text);
            addMessage(botResponse, false);
        }, 500);
}

    sendChat.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
  // Initial bot message
    setTimeout(() => {
        addMessage("Xin ch√†o! T√¥i l√† GGL Chatbot. T√¥i c√≥ th·ªÉ h·ªó tr·ª£ g√¨ cho b·∫°n?");
    }, 1000);
/* ===== DRAGGABLE CHAT BUBBLE ===== */
    const chatBubble = $('.chat-bubble');
    let isDragging = false;
  let offsetX, offsetY;

    chatBubble.addEventListener('mousedown', (e) => {
        isDragging = true;
        chatBubble.classList.add('dragging');
        offsetX = e.clientX - chatBubble.getBoundingClientRect().left;
        offsetY = e.clientY - chatBubble.getBoundingClientRect().top;
    });
  document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        chatBubble.style.left = e.clientX - offsetX + 'px';
        chatBubble.style.top = e.clientY - offsetY + 'px';
    });
  document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        chatBubble.classList.remove('dragging');
    });
  // Prevent text selection while dragging
    chatBubble.addEventListener('selectstart', (e) => {
        e.preventDefault();
    });
});

/* ====== Init load ====== */
renderHeader();
renderMainMenu();
renderSubTabs();
renderContent();
</script>
</body>
</html>
